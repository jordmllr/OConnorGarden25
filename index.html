<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>O'Connor Garden Guide</title>
    <meta name="description" content="Garden plant information guide">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icons/favicon.svg" type="image/svg+xml">
    <meta name="theme-color" content="#4CAF50">

    <!-- iOS PWA specific tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Garden Guide">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-192.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-192.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icons/icon-192.png">

    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Markdown parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Basic styles -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Authentication UI -->
    <div x-data="authHandler()" x-init="init()" class="auth-container" x-show="!$store.auth.user">
        <div class="auth-form">
            <h2>Sign In to Sync Your Garden Tasks</h2>

            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" x-model="email" placeholder="your@email.com">
            </div>

            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" x-model="password" placeholder="Your password">
            </div>

            <div class="error-message" x-show="errorMessage" x-text="errorMessage"></div>

            <div class="auth-buttons">
                <button @click="signIn()" :disabled="isLoading">Sign In</button>
                <button @click="signUp()" :disabled="isLoading">Sign Up</button>
            </div>

            <div class="google-signin">
                <button @click="signInWithGoogle()">
                    <img src="https://developers.google.com/identity/images/btn_google_signin_light_normal_web.png" alt="Sign in with Google">
                </button>
            </div>
        </div>
    </div>

    <div x-data="plantGuide()" x-init="init()" class="container" x-show="$store.auth.user">
        <header>
            <h1>O'Connor Garden Guide</h1>

            <!-- User info and sign out button -->
            <div class="user-info" x-data="authHandler()" x-show="$store.auth.user">
                <span x-text="$store.auth.user ? 'Signed in as: ' + $store.auth.user.email : ''"></span>
                <button @click="signOut()" class="sign-out-btn">Sign Out</button>
            </div>

            <!-- Navigation Menu -->
            <nav class="main-nav">
                <button @click="navigateTo('plants')" :class="{ active: currentView === 'plants' }">
                    <span class="emoji">üå±</span>
                    <span class="name">Plants</span>
                </button>
                <button @click="navigateTo('plot')" :class="{ active: currentView === 'plot' }">
                    <span class="emoji">üè°</span>
                    <span class="name">Plot Layout</span>
                </button>
                <button @click="navigateTo('schedule')" :class="{ active: currentView === 'schedule' }">
                    <span class="emoji">üìÖ</span>
                    <span class="name">Planting Schedule</span>
                </button>
                <button @click="navigateTo('todos')" :class="{ active: currentView === 'todos' }">
                    <span class="emoji">‚úÖ</span>
                    <span class="name">Todo List</span>
                </button>
            </nav>
        </header>

        <main>
            <!-- Plants View Template -->
            <div x-show="currentView === 'plants'">
                <div x-show="!selectedPlant" class="plant-selector">
                    <h2>Select a Plant</h2>
                    <div class="plant-grid">
                        <button @click="selectPlant('Tomatoes')" class="plant-button">
                            <span class="emoji">üçÖ</span>
                            <span class="name">Tomatoes</span>
                        </button>
                        <button @click="selectPlant('Cucumbers')" class="plant-button">
                            <span class="emoji">ü•í</span>
                            <span class="name">Cucumbers</span>
                        </button>
                        <button @click="selectPlant('Pumpkins')" class="plant-button">
                            <span class="emoji">üéÉ</span>
                            <span class="name">Pumpkins</span>
                        </button>
                        <button @click="selectPlant('Onions')" class="plant-button">
                            <span class="emoji">üßÖ</span>
                            <span class="name">Onions</span>
                        </button>
                        <button @click="selectPlant('Romaine')" class="plant-button">
                            <span class="emoji">ü•¨</span>
                            <span class="name">Romaine</span>
                        </button>
                        <button @click="selectPlant('SweetPotatoes')" class="plant-button">
                            <span class="emoji">üç†</span>
                            <span class="name">Sweet Potatoes</span>
                        </button>
                    </div>
                </div>

                <div x-show="selectedPlant" class="plant-info">
                    <button @click="selectedPlant = null" class="back-button">‚Üê Back to Plants</button>
                    <div x-html="plantContent" class="markdown-content"></div>
                </div>
            </div>

            <!-- Plot Layout Template -->
            <div x-show="currentView === 'plot'" x-data="plotManager()" x-init="init()" class="plot-layout">
                <h2>Garden Plot Layout</h2>

                <div x-show="isLoading" class="loading">Loading plot data...</div>

                <div x-show="!isLoading" class="plot-tools">
                    <h3>Select a Plant to Place</h3>
                    <div class="plant-selector-grid">
                        <template x-for="plant in plants" :key="plant.id">
                            <button
                                @click="selectPlant(plant.id)"
                                :class="{ 'selected': selectedPlant === plant.id }"
                                class="plant-select-btn"
                            >
                                <span class="emoji" x-text="plant.emoji"></span>
                                <span class="name" x-text="plant.name"></span>
                            </button>
                        </template>

                        <button @click="selectPlant(null)" class="plant-select-btn clear-btn">
                            <span class="emoji">‚ùå</span>
                            <span class="name">Clear Cell</span>
                        </button>
                    </div>

                    <div class="plot-info">
                        <p><strong>Plot Name:</strong> <span x-text="plotName"></span></p>
                        <p><strong>Dimensions:</strong> <span x-text="plotWidth + ' ft √ó ' + plotHeight + ' ft'"></span></p>
                    </div>
                </div>

                <div x-show="!isLoading" class="plot-container">
                    <div class="plot-grid" :style="'width: ' + (plotWidth * 100) + 'px; height: ' + (plotHeight * 50) + 'px;'">
                        <!-- Grid cells will be created here -->
                        <template x-for="cell in cells" :key="cell.id">
                            <div
                                :id="cell.id"
                                class="grid-cell"
                                :class="{ 'planted': cell.status === 'planted' }"
                                :style="'left: ' + (cell.x * cellSize) + 'px; top: ' + (cell.y * cellSize) + 'px; width: ' + cellSize + 'px; height: ' + cellSize + 'px;'"
                                @click="selectedPlant === null ? clearCell(cell.id) : plantInCell(cell.id)"
                            >
                                <template x-if="cell.plantId">
                                    <div class="plant-indicator">
                                        <span class="plant-emoji" x-text="getPlant(cell.plantId)?.emoji || 'üå±'"></span>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>

                <div x-show="!isLoading" class="plot-legend">
                    <h3>Legend</h3>
                    <div class="legend-items">
                        <template x-for="plant in plants" :key="plant.id">
                            <div class="legend-item">
                                <span class="emoji" x-text="plant.emoji"></span>
                                <span class="name" x-text="plant.name"></span>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Planting Schedule Template -->
            <div x-show="currentView === 'schedule'" class="planting-schedule">
                <h2>Planting Schedule</h2>
                <p>Planting schedule will be implemented here.</p>
            </div>

            <!-- Todo List Template -->
            <div x-show="currentView === 'todos'" x-data="taskManager()" x-init="init()" class="todo-list">
                <h2>Garden Tasks</h2>

                <div x-show="isLoading" class="loading">Loading tasks...</div>

                <div x-show="!isLoading">
                    <!-- Task filters -->
                    <div class="task-filters">
                        <div class="filter-group">
                            <label for="status-filter">Status:</label>
                            <select id="status-filter" x-model="filterStatus" class="filter-select">
                                <option value="all">All</option>
                                <option value="pending">Pending</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <label for="category-filter">Category:</label>
                            <select id="category-filter" x-model="filterCategory" class="filter-select">
                                <option value="all">All Categories</option>
                                <template x-for="category in categories" :key="category">
                                    <option :value="category" x-text="category.charAt(0).toUpperCase() + category.slice(1)"></option>
                                </template>
                            </select>
                        </div>
                    </div>

                    <!-- Add new task form -->
                    <form @submit.prevent="addTask({
                        title: $refs.newTaskTitle.value,
                        description: '',
                        dueDate: $refs.newTaskDueDate.value || new Date(),
                        category: $refs.newTaskCategory.value
                    })" class="task-form">
                        <div class="task-form-inputs">
                            <input
                                type="text"
                                x-ref="newTaskTitle"
                                placeholder="Add a new garden task..."
                                class="task-input"
                                required
                            >
                            <select x-ref="newTaskCategory" class="task-category-select">
                                <template x-for="category in categories" :key="category">
                                    <option :value="category" x-text="category.charAt(0).toUpperCase() + category.slice(1)"></option>
                                </template>
                            </select>
                            <input
                                type="date"
                                x-ref="newTaskDueDate"
                                class="task-date-input"
                            >
                        </div>
                        <button type="submit" class="add-task-btn">Add Task</button>
                    </form>

                    <!-- Task list -->
                    <ul class="tasks-container">
                        <template x-for="task in getFilteredTasks()" :key="task.id">
                            <li class="task-item" :class="{ 'completed': task.completed }">
                                <div class="task-content">
                                    <input
                                        type="checkbox"
                                        :checked="task.completed"
                                        @click="toggleTaskCompletion(task.id)"
                                    >
                                    <div class="task-details">
                                        <div class="task-title-row">
                                            <span class="task-title" x-text="task.title"></span>
                                            <span class="task-category" x-text="task.category"></span>
                                        </div>

                                        <div class="task-meta">
                                            <!-- Due date display -->
                                            <span class="due-date" x-text="'Due: ' + formatDate(task.dueDate)"></span>

                                            <!-- Related planting (if any) -->
                                            <template x-if="task.relatedPlantingId">
                                                <span class="related-planting" x-text="'Plant: ' + (getPlanting(task.relatedPlantingId)?.plantName || 'Unknown')"></span>
                                            </template>

                                            <!-- Recurring indicator -->
                                            <template x-if="task.recurring">
                                                <span class="recurring-indicator">üîÑ Recurring</span>
                                            </template>
                                        </div>
                                    </div>
                                </div>

                                <div class="task-actions">
                                    <!-- Edit button -->
                                    <button @click="$refs['edit-modal-' + task.id].showModal()" class="edit-task-btn">
                                        ‚úèÔ∏è
                                    </button>

                                    <!-- Delete button -->
                                    <button @click="deleteTask(task.id)" class="delete-task-btn">
                                        ‚ùå
                                    </button>
                                </div>

                                <!-- Edit task dialog -->
                                <dialog :id="'edit-task-' + task.id" x-ref="'edit-modal-' + task.id" class="edit-task-dialog">
                                    <form @submit.prevent="
                                        updateTask(task.id, {
                                            title: $refs['edit-title-' + task.id].value,
                                            description: $refs['edit-desc-' + task.id].value,
                                            dueDate: new Date($refs['edit-date-' + task.id].value),
                                            category: $refs['edit-category-' + task.id].value,
                                            priority: $refs['edit-priority-' + task.id].value
                                        });
                                        $refs['edit-modal-' + task.id].close();
                                    ">
                                        <h3>Edit Task</h3>

                                        <div class="form-group">
                                            <label :for="'edit-title-' + task.id">Title</label>
                                            <input
                                                :id="'edit-title-' + task.id"
                                                x-ref="'edit-title-' + task.id"
                                                type="text"
                                                :value="task.title"
                                                required
                                            >
                                        </div>

                                        <div class="form-group">
                                            <label :for="'edit-desc-' + task.id">Description</label>
                                            <textarea
                                                :id="'edit-desc-' + task.id"
                                                x-ref="'edit-desc-' + task.id"
                                                :value="task.description"
                                            ></textarea>
                                        </div>

                                        <div class="form-group">
                                            <label :for="'edit-date-' + task.id">Due Date</label>
                                            <input
                                                :id="'edit-date-' + task.id"
                                                x-ref="'edit-date-' + task.id"
                                                type="date"
                                                :value="task.dueDate ? new Date(task.dueDate).toISOString().split('T')[0] : ''"
                                            >
                                        </div>

                                        <div class="form-group">
                                            <label :for="'edit-category-' + task.id">Category</label>
                                            <select :id="'edit-category-' + task.id" x-ref="'edit-category-' + task.id">
                                                <template x-for="category in categories" :key="category">
                                                    <option
                                                        :value="category"
                                                        :selected="category === task.category"
                                                        x-text="category.charAt(0).toUpperCase() + category.slice(1)"
                                                    ></option>
                                                </template>
                                            </select>
                                        </div>

                                        <div class="form-group">
                                            <label :for="'edit-priority-' + task.id">Priority</label>
                                            <select :id="'edit-priority-' + task.id" x-ref="'edit-priority-' + task.id">
                                                <option value="low" :selected="task.priority === 'low'">Low</option>
                                                <option value="medium" :selected="task.priority === 'medium'">Medium</option>
                                                <option value="high" :selected="task.priority === 'high'">High</option>
                                            </select>
                                        </div>

                                        <div class="dialog-buttons">
                                            <button type="button" @click="$refs['edit-modal-' + task.id].close()">Cancel</button>
                                            <button type="submit">Save Changes</button>
                                        </div>
                                    </form>
                                </dialog>
                            </li>
                        </template>

                        <!-- Empty state -->
                        <li x-show="getFilteredTasks().length === 0" class="empty-state">
                            No garden tasks found. Add some tasks to get started!
                        </li>
                    </ul>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Initialize Firebase -->
    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC3rUx7OFR7-Clnwlm2Ir8Om133xRzbCg4",
            authDomain: "gardenplot-63938.firebaseapp.com",
            projectId: "gardenplot-63938",
            storageBucket: "gardenplot-63938.firebasestorage.app",
            messagingSenderId: "1085971188380",
            appId: "1:1085971188380:web:e1652c05a11f950fe5fb59"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // Initialize Firestore
        const db = firebase.firestore();

        // Enable offline persistence
        db.enablePersistence()
            .catch((err) => {
                if (err.code == 'failed-precondition') {
                    // Multiple tabs open, persistence can only be enabled in one tab at a time
                    console.log('Persistence failed: Multiple tabs open');
                } else if (err.code == 'unimplemented') {
                    // The current browser does not support all of the features required for persistence
                    console.log('Persistence not supported by this browser');
                }
            });
    </script>

    <script src="auth.js"></script>
    <script src="plot-manager.js"></script>
    <script src="task-manager.js"></script>
    <script src="app.js"></script>
    <script src="db-setup.js"></script>
    <script src="firebase-test.js"></script>
    <script>
        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service worker registered'))
                    .catch(err => console.log('Service worker registration failed', err));
            });
        }

        // Initialize the database with plant data (uncomment to run once)
        //setupDatabase();
    </script>
</body>
</html>